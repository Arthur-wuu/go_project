# **filetransfer**

异步导出文件
---
> 异步从db导出数据，生成文件，压缩并上传到aws s3
---
- **需求描述**
1. 导出文件时，相同的数据生成相同的文件名，避免重复生成文件;

2. 导出文件采用异步方式，提升用户体验，文件存储于文件服务器，下载不影响其余系统的性能;

3. 指定用户只能下载指定的文件(安全);

4. 频率控制，单个用户规定时间内只能生成有限任务。

---
- **设计**
1. 采用redis的list作为任务队列，string作为状态存储，满足数据不丢失需求。

2. 两个工作线程（生产者消费者模式），一个生成任务放入队列，另一个消费任务生成文件。

3. 按照传入的sql语句生成md5值作为文件名, sql语句按照空格和逗号分隔后排序

4. 文件存储于 aws s3上，配置相应的过期策略。

5. 为每个s3文件分配一个临时的token，token有效期内可访问文件。

6. 提供API接口，生成订单(生成任务)，查询订单，取消订单。
>> 生成订单：生成文件名，判断文件是否存在于s3上，判断任务队列长度，入队，更新订单状态。

>> 消费订单：判断任务取消或者过期，判断是否存在于s3上（在该任务入队之后才生成的文件），生成文件压缩并上传，生成临时token签名文件url地址，清理。注意：实时更新任务状态。

>> 取消订单：删除 redis中string类型的任务状态。对应上一步中“判断任务取消或者过期”。

>> 查询订单：前端ajax异步 定时30秒查询订单状态，当显示为完成状态时可获取到签名后的文件url地址。下载文件即可。

---
- **不足与未实现**
1. 频率控制未实现，可根据 caller 来限制调用次数。

2. 消费订单不足： 未按照数据库 并发执行。

3. xlsx文件的首行字段，可用参数传入，目前直接用数据库字段名代替。

4. 生成csv文件未实现。

5. 多数据库 未支持，目前支持mysql。
